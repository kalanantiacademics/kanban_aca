<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalananti Board</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            900: '#111827',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'card': '0 2px 10px rgba(0, 0, 0, 0.02)',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F8F9FA;
            color: #111827;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 99px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #D1D5DB;
        }

        .kanban-column {
            min-height: 200px;
        }

        /* Dragging Styles */
        .dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        
        .drag-over {
            background: #EFF6FF; /* Blue-50 */
            border-radius: 16px;
        }
        
        .sidebar-item.active {
            background-color: #EFF6FF;
            color: #2563EB;
            font-weight: 600;
        }

        /* Checkbox Circle */
        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #E5E7EB;
            border-radius: 50%;
            transition: all 0.2s;
            cursor: pointer;
        }
        .task-checkbox:hover {
            border-color: #2563EB;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-[#F8F9FC]">

    <!-- Sidebar -->
    <aside class="w-64 bg-white h-full flex flex-col border-r border-gray-100 flex-shrink-0 transition-all duration-300">
        <!-- Logo -->
        <div class="p-6 flex gap-3 items-center border-b border-gray-50 h-20">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-blue-500/30">K</div>
            <h1 class="font-bold text-gray-800 text-lg tracking-tight">Kalananti</h1>
        </div>

        <!-- Scrollable Nav -->
        <div class="flex-1 overflow-y-auto px-4 py-6 space-y-8 custom-scrollbar">
            
            <!-- Main Nav -->
            <div class="space-y-1">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full sidebar-item active flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="w-full sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" /></svg>
                    All Tasks
                </button>
            </div>

            <!-- Categories -->
            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-3">Projects</h3>
                <div class="space-y-1">
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span> UOB
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-2 h-2 rounded-full bg-purple-500"></span> B2B
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-2 h-2 rounded-full bg-orange-500"></span> B2C
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span> B2S
                    </button>
                </div>
            </div>

            <!-- Quick Filters -->
            <div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-3">Filters</h3>
                <div class="space-y-1">
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                        All Done
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        All Backlog
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                        All To Do
                    </button>
                </div>
            </div>

            <!-- Team Stats (Restricted) -->
            <div id="team-section" class="hidden">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-3">Team Performance</h3>
                <div class="space-y-1">
                     <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 text-xs flex items-center justify-center font-bold">L</span>
                        <span>Laras</span>
                    </button>
                     <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs flex items-center justify-center font-bold">Y</span>
                        <span>Yazid</span>
                    </button>
                     <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-6 h-6 rounded-full bg-green-100 text-green-600 text-xs flex items-center justify-center font-bold">S</span>
                        <span>Saras</span>
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-6 h-6 rounded-full bg-pink-100 text-pink-600 text-xs flex items-center justify-center font-bold">A</span>
                        <span>Aisyah</span>
                    </button>
                    <button class="w-full sidebar-item flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-gray-600 hover:bg-gray-50 transition-all">
                        <span class="w-6 h-6 rounded-full bg-orange-100 text-orange-600 text-xs flex items-center justify-center font-bold">G</span>
                        <span>Galuh</span>
                    </button>
                </div>
            </div>
            
            <!-- Logout -->
            <div class="mt-auto pt-4 border-t border-gray-100">
                <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm text-red-500 hover:bg-red-50 transition-all font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    Logout
                </button>
            </div>

        </div>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden relative">

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="absolute inset-0 z-20 bg-[#F8F9FC] flex flex-col overflow-y-auto custom-scrollbar p-8">
            <!-- Header -->
            <header class="flex justify-between items-center mb-10">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800" id="dash-welcome">Welcome back!</h1>
                    <p class="text-gray-500 mt-1" id="dash-role">Here's your overview for this week.</p>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-sm font-medium text-gray-500" id="current-date">October 24, 2025</span>
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 shadow-lg shadow-blue-500/20"></div>
                </div>
            </header>

            <!-- Dashboard Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Center: Weekly Tasks (Span 2) -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-[24px] shadow-soft border border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                <span class="bg-blue-100 p-1.5 rounded-lg text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                                </span>
                                My Tasks This Week
                            </h2>
                            <button class="text-sm text-blue-600 font-medium hover:bg-blue-50 px-3 py-1 rounded-lg transition-colors">View All</button>
                        </div>
                        
                        <!-- Task List -->
                        <div class="space-y-4" id="dashboard-tasks-list">
                            <!-- Populated via JS -->
                            <div class="text-center py-10 text-gray-400">Loading tasks...</div>
                        </div>
                    </div>
                </div>

                <!-- Right: Calendar & Stats -->
                <div class="space-y-8">
                    <!-- Calendar Widget -->
                    <div class="bg-white p-6 rounded-[24px] shadow-soft border border-gray-100">
                        <h2 class="text-lg font-bold text-gray-800 mb-4">Calendar</h2>
                        <div class="bg-gray-50 rounded-2xl p-4">
                            <!-- Simple visual calendar mockup or logic -->
                            <div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-gray-400 mb-2">
                                <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600" id="mini-calendar-grid">
                                <!-- JS Generated -->
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="bg-blue-600 rounded-[24px] p-6 text-white shadow-lg shadow-blue-500/30 relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-blue-100 font-medium mb-1">Total Completed</h3>
                            <div class="text-4xl font-bold mb-4">12</div>
                            <div class="flex items-center gap-2 text-sm text-blue-100 bg-white/10 w-fit px-3 py-1 rounded-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                                <span>+24% this month</span>
                            </div>
                        </div>
                        <!-- Decor -->
                        <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-blue-400 to-transparent opacity-30 rounded-bl-3xl"></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- KANBAN VIEW -->
        <div id="view-kanban" class="absolute inset-0 z-10 flex flex-col bg-[#F8F9FC] opacity-0 pointer-events-none transition-opacity duration-300">
            <!-- Existing Kanban Content will be wrapped here -->
            
            <!-- Header -->
            <header class="h-20 flex items-center justify-between px-8 border-b border-gray-100 bg-white/50 backdrop-blur-xl flex-shrink-0">
                <div class="flex items-center gap-4">
                    <h1 class="text-xl font-bold text-gray-800">All Tasks Board</h1>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Week Filter -->
                    <select id="weekFilter" onchange="renderBoard()" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-sm font-medium text-gray-600 focus:outline-none focus:border-blue-500 shadow-sm">
                        <option value="this_week">This Week (Tue-Tue)</option>
                        <option value="next_week">Next Week</option>
                        <option value="all">All Tasks</option>
                    </select>

                    <!-- Sync Button -->
                     <button onclick="loadData()" title="Sync Data" class="p-2 bg-white border border-gray-200 text-gray-500 rounded-xl hover:bg-gray-50 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    </button>
                    
                    <button onclick="toggleModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-xl shadow-lg shadow-blue-500/30 transition-all flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        New Task
                    </button>
                </div>
            </header>

            <!-- Kanban Board Area -->
            <div class="flex-1 overflow-x-auto overflow-y-hidden p-8">
                <div class="flex h-full gap-8 min-w-[1600px]">
                    
                    <!-- Column 1: Backlog -->
                    <div class="flex flex-col w-80 flex-shrink-0">
                        <div class="flex items-center justify-between mb-6 px-1">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                                Backlog
                            </h2>
                            <span class="text-gray-400 font-bold text-sm bg-gray-100 px-2 py-1 rounded-md" id="count-backlog">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 pb-4 custom-scrollbar kanban-column" id="backlog" data-status="backlog"></div>
                    </div>

                    <!-- Column 2: To - Do -->
                    <div class="flex flex-col w-80 flex-shrink-0">
                        <div class="flex items-center justify-between mb-6 px-1">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                                To - Do
                            </h2>
                            <span class="text-gray-400 font-bold text-sm bg-gray-100 px-2 py-1 rounded-md" id="count-todo">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 pb-4 custom-scrollbar kanban-column" id="todo" data-status="todo"></div>
                    </div>

                    <!-- Column 3: On Progress -->
                    <div class="flex flex-col w-80 flex-shrink-0">
                        <div class="flex items-center justify-between mb-6 px-1">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                                On Progress
                            </h2>
                            <span class="text-gray-400 font-bold text-sm bg-gray-100 px-2 py-1 rounded-md" id="count-progress">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 pb-4 custom-scrollbar kanban-column" id="progress" data-status="progress"></div>
                    </div>

                    <!-- Column 4: Done (Review) -->
                    <div class="flex flex-col w-80 flex-shrink-0">
                        <div class="flex items-center justify-between mb-6 px-1">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                                Done (Review)
                            </h2>
                            <span class="text-gray-400 font-bold text-sm bg-gray-100 px-2 py-1 rounded-md" id="count-review">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 pb-4 custom-scrollbar kanban-column" id="review" data-status="review"></div>
                    </div>

                    <!-- Column 5: Complete -->
                    <div class="flex flex-col w-80 flex-shrink-0">
                        <div class="flex items-center justify-between mb-6 px-1">
                            <h2 class="font-bold text-gray-700 flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                Complete
                            </h2>
                            <span class="text-gray-400 font-bold text-sm bg-gray-100 px-2 py-1 rounded-md" id="count-complete">0</span>
                        </div>
                        <div class="flex-1 overflow-y-auto space-y-4 pr-2 pb-4 custom-scrollbar kanban-column" id="complete" data-status="complete"></div>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div id="taskModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-gray-900/20 backdrop-blur-sm transition-opacity" onclick="toggleModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden animate-slideUp flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 flex-shrink-0">
                    <h3 class="text-xl font-bold text-gray-800">New Task</h3>
                    <button onclick="toggleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="taskForm" onsubmit="handleAddTask(event)" class="flex flex-col flex-1 overflow-hidden">
                    <div class="p-6 space-y-5 overflow-y-auto custom-scrollbar">
                        
                        <!-- Title -->
                        <div>
                            <label for="taskTitle" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Title</label>
                            <input type="text" id="taskTitle" required class="mt-2 w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-800 placeholder-gray-400" placeholder="What needs to be done?">
                        </div>
                        
                        <!-- Tag & Date -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="taskTag" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Category</label>
                                <select id="taskTag" class="mt-2 w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-600">
                                    <option value="UOB">UOB</option>
                                    <option value="MDS">MDS</option>
                                    <option value="B2C">B2C</option>
                                    <option value="B2B">B2B</option>
                                    <option value="B2S">B2S</option>
                                    <option value="B2G">B2G</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="taskDate" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Due Date</label>
                                <input type="date" id="taskDate" class="mt-2 w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-600">
                            </div>
                        </div>

                        <!-- Priority -->
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Priority</label>
                            <div class="flex gap-2 mt-2">
                                 <label class="cursor-pointer flex-1">
                                    <input type="radio" name="priority" value="low" class="peer sr-only">
                                    <div class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-medium text-gray-500 peer-checked:bg-green-50 peer-checked:text-green-600 peer-checked:border-green-200 transition-all text-center hover:bg-gray-50">Low</div>
                                </label>
                                <label class="cursor-pointer flex-1">
                                    <input type="radio" name="priority" value="medium" class="peer sr-only" checked>
                                    <div class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-medium text-gray-500 peer-checked:bg-amber-50 peer-checked:text-amber-600 peer-checked:border-amber-200 transition-all text-center hover:bg-gray-50">Medium</div>
                                </label>
                                <label class="cursor-pointer flex-1">
                                    <input type="radio" name="priority" value="high" class="peer sr-only">
                                    <div class="px-3 py-2 rounded-xl border border-gray-200 text-sm font-medium text-gray-500 peer-checked:bg-red-50 peer-checked:text-red-600 peer-checked:border-red-200 transition-all text-center hover:bg-gray-50">High</div>
                                </label>
                            </div>
                        </div>

                        <!-- Evidence (Optional) -->
                        <div id="evidenceFieldWrapper">
                            <label for="taskEvidence" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Evidence Link</label>
                            <input type="text" id="taskEvidence" class="mt-2 w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-800 placeholder-gray-400" placeholder="https://...">
                        </div>

                        <!-- Subtasks Feature -->
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase tracking-wide flex justify-between items-center mb-2">
                                To-Do List
                                <button type="button" onclick="addSubtaskInput()" class="text-blue-600 hover:text-blue-700 text-[10px] bg-blue-50 px-2 py-1 rounded-md transition-colors">+ Add Item</button>
                            </label>
                            <div id="subtasks-container" class="space-y-2">
                                <!-- Dynamic Inputs -->
                            </div>
                        </div>

                    </div>

                    <div class="p-6 border-t border-gray-100 flex justify-end gap-3 bg-gray-50/50">
                        <button type="button" onclick="toggleModal()" class="px-5 py-2.5 rounded-xl text-gray-500 hover:bg-gray-100 font-medium transition-all">Cancel</button>
                        <button type="submit" class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02]">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-gray-900/50 backdrop-blur-md flex items-center justify-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full mx-4 border border-white/20">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4 shadow-lg shadow-blue-500/30">K</div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
                <p class="text-gray-500 text-sm mt-2">Please sign in to access the board</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label for="emailInput" class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Email Address</label>
                    <input type="email" id="emailInput" required 
                        class="w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-800 placeholder-gray-400" 
                        placeholder="name@kalananti.id">
                    <p id="loginError" class="text-red-500 text-xs mt-2 hidden"></p>
                </div>
                
                <button type="submit" id="loginBtn" class="w-full py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg shadow-blue-500/30 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>Sign In</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
    <!-- Evidence Modal -->
    <div id="evidenceModal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity" onclick="toggleEvidenceModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 overflow-hidden animate-slideUp">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                    <h3 class="text-xl font-bold text-gray-800">Submit Evidence</h3>
                    <button onclick="toggleEvidenceModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <form id="evidenceForm" onsubmit="submitEvidence(event)">
                    <input type="hidden" id="evidenceTaskId">
                    <div class="p-6 space-y-4">
                        <p class="text-sm text-gray-500">Please provide proof of completion (Link or Text) to move this task to Review.</p>
                        <div>
                            <label for="evidenceInput" class="text-xs font-bold text-gray-500 uppercase tracking-wide">Evidence / Link</label>
                            <input type="text" id="evidenceInput" required class="mt-2 w-full px-4 py-3 rounded-xl bg-gray-50 border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all font-medium text-gray-800 placeholder-gray-400" placeholder="https://docs.google.com/...">
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-100 bg-gray-50/50 flex justify-end gap-3">
                        <button type="button" onclick="toggleEvidenceModal()" class="px-6 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-semibold hover:bg-gray-100 transition-all">Cancel</button>
                        <button type="submit" class="px-6 py-2.5 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all transform active:scale-95">Submit & Move</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- API CONFIGURATION ---
        // Placeholder for GAS Template (ignored if serving static HTML)
        const API_URL_TEMPLATE = '<?= apiUrl ?>'; 
        const API_URL_FALLBACK = 'https://script.google.com/macros/s/AKfycbzA6yu0fYx0kS8dG03ZVlp0DWA2xILvukxsouGJGGlipdSWW3O9yx4z_u3ErcL8PhgjBQ/exec';

        // Logic: If template is not replaced (still contains '<?'), use Fallback
        const EFFECTIVE_API_URL = (!API_URL_TEMPLATE.includes('<?')) ? API_URL_TEMPLATE : API_URL_FALLBACK;
        const API_URL = EFFECTIVE_API_URL; // Alias for backward compatibility

        async function fetchFromGas(action, params = {}, method = 'GET') {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined' || !google.script) {
                    // Fallback for Local Dev / GitHub Pages (CORS might fail, but logic remains)
                    // console.warn('Google Script Run not available, falling back to Fetch for:', action);
                    // Legacy Fetch Logic: ALWAYS USE GET to avoid CORS preflight issues with GAS
                    const url = new URL(EFFECTIVE_API_URL);
                    url.searchParams.append('action', action);
                    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
                    
                    fetch(url.toString(), { method: 'GET' })
                        .then(res => res.json())
                        .then(data => resolve(data))
                        .catch(err => reject(err));
                    return;
                }

                // Map 'action' string to function name in Code.gs
                // We created specific wrappers: api_addTask, api_updateStatus, api_approveTask
                let run = google.script.run
                    .withSuccessHandler(response => resolve(response))
                    .withFailureHandler(error => reject(error));

                // Route to correct server-function
                switch(action) {
                    case 'getKanbanData':
                        run.getKanbanData();
                        break;
                    case 'checkLogin':
                        run.api_checkLogin(params.email || params);
                        break;
                    case 'addTask':
                        run.api_addTask(params);
                        break;
                    case 'updateStatus':
                        run.api_updateStatus(params);
                        break;
                    case 'approveTask':
                        run.api_approveTask(params);
                        break;
                    default:
                        reject("Unknown Action: " + action);
                }
            });
        }

        // --- View & Dashboard Logic ---
        function switchView(viewName) {
            const dashView = document.getElementById('view-dashboard');
            const kanbanView = document.getElementById('view-kanban');
            const navDash = document.getElementById('nav-dashboard');
            const navKanban = document.getElementById('nav-kanban');

            if (viewName === 'dashboard') {
                dashView.style.zIndex = 20;
                dashView.style.opacity = 1;
                dashView.style.pointerEvents = 'auto';
                
                kanbanView.style.zIndex = 10;
                kanbanView.style.opacity = 0;
                kanbanView.style.pointerEvents = 'none';

                navDash.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                navDash.classList.remove('text-gray-600', 'hover:bg-gray-50');
                
                navKanban.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                navKanban.classList.add('text-gray-600', 'hover:bg-gray-50');
                
                renderDashboard();
            } else {
                kanbanView.style.zIndex = 20;
                kanbanView.style.opacity = 1;
                kanbanView.style.pointerEvents = 'auto';
                
                dashView.style.zIndex = 10;
                dashView.style.opacity = 0;
                dashView.style.pointerEvents = 'none';

                navKanban.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                navKanban.classList.remove('text-gray-600', 'hover:bg-gray-50');
                
                navDash.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                navDash.classList.add('text-gray-600', 'hover:bg-gray-50');
            }
        }

        function renderDashboard() {
            const user = JSON.parse(localStorage.getItem('kalananti_user') || '{}');
            document.getElementById('dash-welcome').innerText = `Welcome back, ${user.name || 'Friend'}!`;
            document.getElementById('dash-role').innerText = user.role || 'Member';
            
            // Set Current Date
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').innerText = now.toLocaleDateString('en-US', options);

            // Render Calendar
            renderCalendar();

            // Render My Tasks (Mock logic using current tasks)
            // Filter by "Assigned to me" (Tag === Name? Or need new field? User said "task yang harus dikerjakan oleh orang itu")
            // Assuming 'tag' or 'pic' field matches User Name. In Code.gs we mapped PIC to 'tag'.
            // Simple match test:
            const myTasks = tasks.filter(t => {
                // Fuzzy match for demo since PIC data might vary
                return t.tag && user.name && t.tag.toLowerCase().includes(user.name.toLowerCase());
            });

            const taskList = document.getElementById('dashboard-tasks-list');
            if (myTasks.length === 0) {
                taskList.innerHTML = `<div class="p-4 border border-dashed border-gray-200 rounded-xl text-center text-gray-400">No tasks assigned to you this week.</div>`;
            } else {
                taskList.innerHTML = myTasks.map(task => `
                    <div class="flex items-center gap-4 p-4 rounded-xl border border-gray-100 hover:border-blue-200 hover:bg-blue-50/50 transition-all group cursor-pointer" onclick="switchView('kanban')">
                        <div class="w-10 h-10 rounded-full bg-white border border-gray-100 flex items-center justify-center text-gray-500 shadow-sm relative">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 line-clamp-1">${task.title}</h4>
                            <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                <span class="px-2 py-0.5 rounded-md bg-white border border-gray-200">${task.status}</span>
                                <span>Due: ${task.date}</span>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                `).join('');
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('mini-calendar-grid');
            grid.innerHTML = '';
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const today = now.getDate();

            // Get days in current month
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            for(let i=1; i<=daysInMonth; i++) {
                const day = document.createElement('div');
                const isToday = i === today;
                day.className = `p-2 rounded-lg text-sm cursor-pointer hover:bg-gray-100 transition-colors ${isToday ? 'bg-blue-600 text-white font-bold hover:bg-blue-700' : ''}`;
                day.innerText = i;
                grid.appendChild(day);
            }
        }

        function handleLogout() {
            localStorage.removeItem('kalananti_user');
            location.reload();
        }

        // --- Authentication ---
        const loginOverlay = document.getElementById('loginOverlay');
        const loginError = document.getElementById('loginError');
        const loginBtn = document.getElementById('loginBtn');
        
        function checkSession() {
            const session = localStorage.getItem('kalananti_user');
            if (session) {
                const user = JSON.parse(session);
                console.log('Logged in as:', user.name);
                console.log('Logged in as:', user.name);
                loginOverlay.style.display = 'none'; // Force hide
                loginOverlay.classList.add('hidden');
                loginOverlay.classList.remove('flex'); // Remove flex conflict
                
                // Show Team Section if Lead
                const teamSection = document.getElementById('team-section');
                if (teamSection) {
                    if (user.role === 'Team Lead') {
                        teamSection.classList.remove('hidden');
                    } else {
                        teamSection.classList.add('hidden');
                    }
                }

                // Initial View
                renderDashboard();
                loadData(); // Load board data
            } else {
                loginOverlay.classList.remove('hidden');
                loginOverlay.classList.add('flex'); // Restore flex
                loginOverlay.style.display = ''; // Clear inline style
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            
            // UI Loading State
            loginBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            loginBtn.disabled = true;
            loginError.classList.add('hidden');


            // API Logic uses global fetchFromGas
            if (API_URL && API_URL !== 'YOUR_WEB_APP_URL_HERE') {
                fetchFromGas('checkLogin', { email: email })
                    .then(response => {
                        if (response.valid) {
                            localStorage.setItem('kalananti_user', JSON.stringify(response.user));
                            location.reload(); 
                        } else {
                            showLoginError(response.message);
                        }
                    })
                    .catch(err => {
                        showLoginError('Connection failed. Please try again.');
                    });
            } else {
        // Fallback or Alert if URL not set
        console.warn('API_URL not set');
         if (typeof google !== 'undefined' && google.script) {
             // Fallback to internal if still inside GAS (unlikely if goal is split)
                google.script.run
                    .withSuccessHandler(response => {
                        if (response.valid) {
                            localStorage.setItem('kalananti_user', JSON.stringify(response.user));
                            location.reload(); 
                        } else {
                            showLoginError(response.message);
                        }
                    })
                    .withFailureHandler(err => {
                        showLoginError('Connection failed. Please try again.');
                    })
                    .checkLogin(email);
         } else {
             // Local Dev Bypass final fallback
            console.log('Local Dev Login Bypass for:', email);
            localStorage.setItem('kalananti_user', JSON.stringify({ name: 'Dev User', role: 'Team Lead' }));
            location.reload();
         }
    }
        }

        function showLoginError(msg) {
            loginError.innerText = msg;
            loginError.classList.remove('hidden');
            loginBtn.innerHTML = 'Sign In';
            loginBtn.disabled = false;
        }

        // --- State Management ---
        const DEMO_TASKS = [
            { id: '1', title: 'Organize a Weekly Team Meeting', tag: 'Important Tasks', priority: 'high', date: '29/08/2025', time: '9:30 AM', status: 'backlog' },
            { id: '2', title: 'Submit Client Proposal', tag: 'Plans for the Future', priority: 'medium', date: '29/08/2025', time: '11:00 AM', status: 'progress' },
            { id: '3', title: 'Schedule User Interview', tag: 'Research', priority: 'low', date: 'Today', time: '2:00 PM', status: 'done' }, // Keeping internal key 'done' for simplicity in mapping or specific key? Let's use specific
            { id: '4', title: 'Review the New Contract', tag: 'Important Tasks', priority: 'high', date: 'Tomorrow', time: '', status: 'review' },
            { id: '5', title: 'Prepare the Marketing Presentation', tag: 'Work', priority: 'medium', date: '30/08/2025', time: '10:00 AM', status: 'todo' },
        ];

        // Ensure backward compatibility or clear storage if schema changes dramatically? 
        // For this user request, we just adapt.
        let tasks = JSON.parse(localStorage.getItem('kanban-tasks-v2')) || DEMO_TASKS;

        // --- DOM Elements ---
        const columns = {
            backlog: document.getElementById('backlog'),
            todo: document.getElementById('todo'),
            progress: document.getElementById('progress'),
            review: document.getElementById('review'),
            complete: document.getElementById('complete')
        };
        const counts = {
            backlog: document.getElementById('count-backlog'),
            todo: document.getElementById('count-todo'),
            progress: document.getElementById('count-progress'),
            review: document.getElementById('count-review'),
            complete: document.getElementById('count-complete')
        };
        const taskModal = document.getElementById('taskModal');

        // --- Date Helpers ---
        function getCycleRange(offsetWeeks = 0) {
            const now = new Date();
            const day = now.getDay(); // 0-6 (Sun-Sat)
            const hour = now.getHours();
            
            // Find "Current Cycle Start" (Most recent Tuesday 1PM)
            // Tuesday is 2.
            let daysSinceTuesday = day - 2;
            if (daysSinceTuesday < 0) daysSinceTuesday += 7;
            
            // If it's Tuesday but before 13:00, we satisfy the condition of "Previous Cycle" effectively, 
            // so we go back 7 days.
            if (day === 2 && hour < 13) {
                 daysSinceTuesday = 7;
            }

            const start = new Date(now);
            start.setDate(now.getDate() - daysSinceTuesday + (offsetWeeks * 7));
            start.setHours(13, 0, 0, 0); // Tuesday 1 PM
            
            const end = new Date(start);
            end.setDate(start.getDate() + 7); // Next Tuesday 1 PM
            
            return { start, end };
        }

        function isDateInCycle(dateStr, offset = 0) {
            if (!dateStr || dateStr === 'No Date' || dateStr === 'Ongoing') return true; // Keep active stuff?
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return false;
            
            const { start, end } = getCycleRange(offset);
            return d >= start && d < end;
        }

        // --- Init ---

        function populateWeekFilter() {
            const filterEl = document.getElementById('weekFilter');
            if(!filterEl) return;
            
            const uniquePeriods = [...new Set(tasks.map(t => t.period).filter(p => p && p !== 'Uncategorized'))];
            const currentVal = filterEl.value;
            
            filterEl.innerHTML = `
                <option value="all">All Tasks</option>
                <optgroup label="Smart Filters">
                    <option value="this_week">Current Cycle (Tue-Tue)</option>
                    <option value="next_week">Next Cycle</option>
                </optgroup>
            `;
            
            if (uniquePeriods.length > 0) {
                const group = document.createElement('optgroup');
                group.label = "By Spreadsheet Week";
                uniquePeriods.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.innerText = p;
                    group.appendChild(opt);
                });
                filterEl.appendChild(group);
            }
            
            if ([...filterEl.options].some(o => o.value === currentVal)) {
                filterEl.value = currentVal;
            } else {
                filterEl.value = 'all'; 
            }
        }

        let isFilterPopulated = false;

        function renderBoard() {
             // Populate Filters unique to data
            if (!isFilterPopulated && tasks.length > 0) {
                populateWeekFilter();
                isFilterPopulated = true;
            }

            // Clear cols
            Object.values(columns).forEach(col => col.innerHTML = '');
            
            const filterEl = document.getElementById('weekFilter');
            const filter = filterEl ? filterEl.value : 'all'; 
            
            // Render Tasks
            tasks.forEach(task => {
                // Filter Logic
                let visible = true;
                
                if (filter === 'all') {
                    visible = true;
                } else if (filter === 'this_week') {
                    visible = isDateInCycle(task.date, 0);
                } else if (filter === 'next_week') {
                    visible = isDateInCycle(task.date, 1);
                } else {
                    // Period Filter
                    visible = task.period === filter;
                }
                
                if (visible) {
                    const card = createTaskElement(task);
                    if(columns[task.status]) {
                        columns[task.status].appendChild(card);
                    } else {
                        columns['backlog'].appendChild(card);
                    }
                }
            });

            // Update counts
            updateCounts();
        }

        // --- Data Fetching ---
        function loadData() {
            if (API_URL !== 'YOUR_WEB_APP_URL_HERE') {
            console.log('Fetching data from Google Sheets via API...');
            fetchFromGas('getKanbanData')
                .then(item => {
                    console.log('Data received:', item);
                    if (item && item.length > 0) {
                        tasks = item;
                        localStorage.setItem('kanban-tasks-v2', JSON.stringify(tasks));
                        isFilterPopulated = false; // Reset filter populate
                        renderBoard();
                        renderDashboard();
                    } else {
                        renderBoard(); 
                        renderDashboard();
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch data', err);
                    renderBoard();
                    renderDashboard();
                });
        } else if (typeof google !== 'undefined' && google.script) {
                console.log('Local Mode: Using Demo Data');
                renderBoard();
                renderDashboard();
            }
        }

        // Initialize
        checkSession();
        // Note: loadData is called inside checkSession if logged in. 
        // If not logged in, we don't load data until login success. 

        // --- Subtask Logic ---
        function addSubtaskInput() {
            const container = document.getElementById('subtasks-container');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 animate-fadeIn';
            div.innerHTML = `
                <input type="checkbox" disabled class="w-4 h-4 text-blue-600 rounded-md border-gray-300 bg-gray-100 cursor-not-allowed">
                <input type="text" name="subtask[]" placeholder="What needs to be done?" class="flex-1 px-3 py-2 rounded-lg bg-gray-50 border-gray-200 text-sm focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-gray-700">
                <button type="button" onclick="this.parentElement.remove()" class="text-gray-400 hover:text-red-500 p-1 rounded-md hover:bg-red-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            `;
            container.appendChild(div);
            div.querySelector('input[type="text"]').focus();
        }

        async function handleAddTask(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            
            // UI Feedback
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = editingTaskId ? 'Updating...' : 'Adding...';

            try {
                // Get Form Data
                const title = document.getElementById('taskTitle').value;
                const category = document.getElementById('taskTag').value;
                const date = document.getElementById('taskDate').value;
                const priority = form.querySelector('input[name="priority"]:checked').value;
                const evidence = document.getElementById('taskEvidence').value;

                // Get Current User
                const user = JSON.parse(localStorage.getItem('kalananti_user') || '{}');
                const isMember = user.role !== 'Team Lead'; 

                // Construct Params
                const params = {
                    title: title,
                    category: category,
                    date: date,
                    priority: priority,
                    evidence: evidence, // Send Evidence
                    user: user.name || 'Unknown',
                    isUrgent: isMember ? 'true' : 'false' // Members force to To-Do/Urgent logic? Or just Backlog?
                    // Original code had logic. I will preserve it.
                };

                console.log('Sending Task:', params);

                if (editingTaskId) {
                     // EDIT MODE
                     params.id = editingTaskId;
                     // params.action = 'editTask'; // Handled by fetchFromGas name
                     
                     if (API_URL !== 'YOUR_WEB_APP_URL_HERE') {
                        const res = await fetchFromGas('editTask', params, 'POST'); // Use GET
                        if (res.success) {
                            toggleModal(); // Resets editingTaskId
                            loadData(); 
                        } else {
                            throw new Error(res.error || 'Edit Failed');
                        }
                     } else {
                         // Local Mock
                         const t = tasks.find(x => x.id === editingTaskId);
                         if(t) {
                             t.title = category ? `[${category}] ${title}` : title;
                             t.tag = category;
                             t.priority = priority;
                             t.date = date;
                             t.evidence = evidence;
                             // t.user = ?
                         }
                         renderBoard();
                         toggleModal();
                     }

                } else {
                    // CREATE MODE
                    if (API_URL !== 'YOUR_WEB_APP_URL_HERE') {
                        // Use POST for Write Action (Actually GET per recent fix)
                        const res = await fetchFromGas('addTask', params, 'POST'); 
                        if (res.success) {
                            form.reset();
                            toggleModal();
                            loadData(); // Reload to see new task
                        } else {
                            throw new Error(res.error || 'Server Error');
                        }
                    } else {
                        // Local Fallback
                         tasks.push({
                            id: Date.now().toString(),
                            title: category ? `[${category}] ${title}` : title,
                            tag: category,
                            priority: priority,
                            date: date,
                            evidence: evidence,
                            status: isMember ? 'todo' : 'backlog',
                            approved: false
                        });
                        renderBoard();
                        toggleModal();
                        form.reset();
                    }
                }

            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                document.getElementById('subtasks-container').innerHTML = ''; // Clear Subtasks
            }
        }

        function toggleSubtask(taskId, subtaskIdx) {
            const task = tasks.find(t => t.id === taskId);
            if (task && task.subtasks && task.subtasks[subtaskIdx]) {
                task.subtasks[subtaskIdx].done = !task.subtasks[subtaskIdx].done;
                saveTasks();
                renderBoard(); // re-render to show update
            }
        }
        
        function saveTasks() {
            localStorage.setItem('kanban-tasks-v2', JSON.stringify(tasks));
        }
        function createTaskElement(task) {
            const div = document.createElement('div');
            // Custom Styling for Cards
            div.className = 'bg-white p-5 rounded-[20px] shadow-sm border border-gray-100 cursor-grab active:cursor-grabbing hover:shadow-md transition-all duration-300 relative group';
            div.draggable = true;
            div.id = task.id;

            // Priority badge styles
            let priorityBadge = '';
            if (task.priority === 'high') priorityBadge = '<span class="px-2 py-1 rounded-md bg-red-100 text-red-600 text-xs font-bold">!!! High</span>';
            if (task.priority === 'medium') priorityBadge = '<span class="px-2 py-1 rounded-md bg-orange-100 text-orange-600 text-xs font-bold">!! Medium</span>';
            if (task.priority === 'low') priorityBadge = '<span class="px-2 py-1 rounded-md bg-green-100 text-green-600 text-xs font-bold">! Low</span>';

            // Tag styles
            const tagColor = 'bg-blue-100 text-blue-600';

            div.innerHTML = `
                <div class="flex items-start gap-4">
                    <div class="task-checkbox flex-shrink-0 mt-1" onclick="event.stopPropagation(); toggleComplete('${task.id}')">
                        ${task.status === 'complete' ? '<div class="w-full h-full bg-blue-500 rounded-full"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-gray-800 font-bold mb-2 leading-tight ${task.status === 'complete' ? 'line-through text-gray-400' : ''}">${task.title}</h4>
                        
                        <div class="flex flex-wrap gap-2 mb-3">
                            <div class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-gray-50 text-gray-500 text-xs font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                ${task.date}
                            </div>
                        </div>

                        ${task.evidence ? (() => {
                            const evidenceText = String(task.evidence);
                            const isUrl = evidenceText.startsWith('http') || evidenceText.startsWith('www');
                            const displayContent = isUrl 
                                ? `<a href="${evidenceText}" target="_blank" class="underline hover:text-blue-600" onclick="event.stopPropagation()">${evidenceText}</a>`
                                : evidenceText;
                            
                            return `
                            <div class="mb-3 p-2 bg-blue-50 border border-blue-100 rounded-lg text-xs text-blue-800 break-words">
                                <span class="font-bold">Evidence:</span> ${displayContent}
                            </div>`;
                        })() : ''}

                        <div class="flex items-center gap-2">
                            ${priorityBadge}
                            <span class="px-2 py-1 rounded-md ${tagColor} text-xs font-bold truncate max-w-[100px]">${task.tag}</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                         ${task.status !== 'complete' ? `
                        <button onclick="event.stopPropagation(); openEditModal('${task.id}')" class="text-gray-300 hover:text-blue-500" title="Edit">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        ` : ''}
                        
                        <button onclick="deleteTask(event, '${task.id}')" class="text-gray-300 hover:text-red-400" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            // Drag Events
            div.addEventListener('dragstart', dragStart);
            div.addEventListener('dragend', dragEnd);

            return div;
        }

        function approveTask(id, checkbox) {
            if (API_URL !== 'YOUR_WEB_APP_URL_HERE') {
                checkbox.disabled = true;
                console.log('Approving Task:', id);
                
                fetchFromGas('approveTask', { id: id }, 'POST')
                    .then(res => {
                        if (res.success) {
                            loadData(); // Sync to see it move to To Do
                        } else {
                            alert('Approval failed: ' + res.error);
                            checkbox.checked = !checkbox.checked; // Revert
                            checkbox.disabled = false;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Connection Error');
                        checkbox.checked = !checkbox.checked; // Revert
                        checkbox.disabled = false;
                    });
            } else {
                console.log('Local Approve:', id);
                const t = tasks.find(t => t.id === id);
                if (t) {
                    t.approved = true;
                    // Mock Move
                    t.status = 'todo';
                    renderBoard();
                }
            }
        }

        function updateCounts() {
            Object.keys(counts).forEach(key => {
                const count = tasks.filter(t => t.status === key).length;
                counts[key].innerText = count;
            });
        }

        // --- Status Transitions ---
        function toggleComplete(id) {
            const task = tasks.find(t => t.id === id);
            console.log('Toggling Task:', id, task);
            if (!task) return;

            console.log('Current Status:', task.status);

            // Logic:
            // Backlog -> (Blocked, need Approval)
            // To Do -> Progress
            // Progress -> Review (Need Evidence)
            // Review -> Complete
            // Complete -> To Do (Reopen?)

            if (task.status === 'backlog') {
                alert('Task in Backlog needs Team Lead approval via checkbox.');
                return;
            }

            if (task.status === 'todo') {
                // To Do -> Progress
                updateTaskStatus(id, 'progress');
            } else if (task.status === 'progress') {
                console.log('Status is progress, opening modal...');
                // Progress -> Review (Require Evidence)
                openEvidenceModal(id);
            } else if (task.status === 'review') {
                // Review -> Complete
                updateTaskStatus(id, 'complete');
            } else if (task.status === 'complete') {
                 // Reopen?
                 if(confirm("Reopen this task to To Do?")) {
                    updateTaskStatus(id, 'todo');
                 }
            }
        }

        async function updateTaskStatus(id, newStatus, evidence = '') {
            const task = tasks.find(t => t.id === id);
            if(!task) return;

            // Optimistic Update
            const oldStatus = task.status;
            task.status = newStatus;
            renderBoard();

            try {
                if (API_URL !== 'YOUR_WEB_APP_URL_HERE') {
                    const res = await fetchFromGas('updateStatus', { 
                        id: id, 
                        status: newStatus,
                        evidence: evidence
                    }, 'POST');
                    
                    if (!res.success) throw new Error(res.error);
                }
            } catch (err) {
                console.error("Update Failed", err);
                alert("Failed to update status. Reverting...");
                task.status = oldStatus;
                renderBoard();
            }
        }

        // --- Evidence Logic ---
        function toggleEvidenceModal() {
            const el = document.getElementById('evidenceModal');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) {
                document.getElementById('evidenceInput').focus();
            }
        }

        function openEvidenceModal(taskId) {
            console.log('openEvidenceModal Called for:', taskId);
            document.getElementById('evidenceTaskId').value = taskId;
            document.getElementById('evidenceInput').value = '';
            toggleEvidenceModal();
        }

        function submitEvidence(e) {
            e.preventDefault();
            const id = document.getElementById('evidenceTaskId').value;
            const evidence = document.getElementById('evidenceInput').value;
            
            toggleEvidenceModal();
            // Move to Review with Evidence
            updateTaskStatus(id, 'review', evidence);
        }
        
        function deleteTask(e, id) {
            e.stopPropagation();
            if(confirm('Delete this task?')) {
                tasks = tasks.filter(t => t.id !== id);
                renderBoard();
            }
        }

        // --- Drag & Drop Logic ---
        let draggedItem = null;

        function dragStart(e) {
            draggedItem = this;
            setTimeout(() => this.classList.add('dragging'), 0);
        }

        function dragEnd() {
            this.classList.remove('dragging');
            draggedItem = null;
            document.querySelectorAll('.kanban-column').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        document.querySelectorAll('.kanban-column').forEach(column => {
            column.addEventListener('dragover', e => {
                e.preventDefault();
                column.classList.add('drag-over');
            });

            column.addEventListener('dragleave', e => {
                column.classList.remove('drag-over');
            });

            column.addEventListener('drop', e => {
                e.preventDefault();
                column.classList.remove('drag-over');
                
                const newStatus = column.getAttribute('data-status');
                console.log('Dropped into:', newStatus);

                if (draggedItem) {
                    const taskId = draggedItem.id;

                    // If moving to Review/Done, require evidence
                    if (newStatus === 'review') {
                        console.log('Target is review. Checking requirement...');
                        // Check if it's not already in review?
                        const task = tasks.find(t => t.id === taskId);
                         console.log('Task status:', task?.status);
                        if (task && task.status !== 'review') {
                            console.log('Opening Modal from Drop');
                            openEvidenceModal(taskId);
                            return; // Stop immediate drop
                        }
                    }

                    column.appendChild(draggedItem);
                    
                    const taskIndex = tasks.findIndex(t => t.id === taskId);
                    if (taskIndex > -1) {
                         // If moving TO progress, ensure it's mapped correctly (though simple update is fine)
                        updateTaskStatus(taskId, newStatus);
                        // renderBoard(); // updateTaskStatus calls renderBoard
                    }
                }
            });
        });

        // --- Actions ---
        let editingTaskId = null;

        function toggleModal() {
            taskModal.classList.toggle('hidden');
            if(!taskModal.classList.contains('hidden')) {
                document.getElementById('taskTitle').focus();
            } else {
                // Reset on close
                editingTaskId = null;
                document.getElementById('taskForm').reset();
                document.getElementById('taskEvidence').value = ''; 
                document.querySelector('#taskModal h3').innerText = 'New Task';
                document.querySelector('#taskModal button[type="submit"]').innerText = 'Create Task';
            }
        }

        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('taskTitle').value = task.title.replace(/^\[.*?\]\s/, ''); // Remove tag from title if present
            document.getElementById('taskTag').value = task.tag || 'Other';
             // Date might be simple string or ISO. If ISO, take first 10 chars.
            if (task.date && task.date.includes('T')) {
                 document.getElementById('taskDate').value = task.date.split('T')[0];
            } else {
                 document.getElementById('taskDate').value = task.date;
            }
            
            // Priority
            const radio = document.querySelector(`input[name="priority"][value="${task.priority}"]`);
            if (radio) radio.checked = true;

            // Evidence
            document.getElementById('taskEvidence').value = task.evidence || '';

            document.querySelector('#taskModal h3').innerText = 'Edit Task';
            document.querySelector('#taskModal button[type="submit"]').innerText = 'Update Task';
            
            taskModal.classList.remove('hidden');
        }



        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !taskModal.classList.contains('hidden')) {
                toggleModal();
            }
        });

    </script>
</body>
</html>
